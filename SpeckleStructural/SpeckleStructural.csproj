<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')" />
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProjectGuid>{F7980709-1E82-44B6-B3F8-0450A1FE6DC3}</ProjectGuid>
    <OutputType>Library</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>SpeckleStructural</RootNamespace>
    <AssemblyName>SpeckleStructural</AssemblyName>
    <TargetFrameworkVersion>v4.7.1</TargetFrameworkVersion>
    <FileAlignment>512</FileAlignment>
    <Deterministic>true</Deterministic>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <DebugSymbols>true</DebugSymbols>
    <DebugType>portable</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <PlatformTarget>x64</PlatformTarget>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <DebugType>none</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <PlatformTarget>AnyCPU</PlatformTarget>
  </PropertyGroup>
  <PropertyGroup>
    <IncludeSymbols>true</IncludeSymbols>
    <SymbolPackageFormat>snupkg</SymbolPackageFormat>
  </PropertyGroup>
  <ItemGroup>
    <Reference Include="System" />
    <Reference Include="System.Core" />
    <Reference Include="System.Xml.Linq" />
    <Reference Include="System.Data.DataSetExtensions" />
    <Reference Include="Microsoft.CSharp" />
    <Reference Include="System.Data" />
    <Reference Include="System.Net.Http" />
    <Reference Include="System.Xml" />
  </ItemGroup>
  <ItemGroup>
    <Compile Include="Base.cs" />
    <Compile Include="Properties\AssemblyInfo.cs" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\SpeckleStructuralGSA\SpeckleStructuralGSA.csproj">
      <Project>{686cf31d-5d4c-4e57-a2fc-267ec7bb78c5}</Project>
      <Name>SpeckleStructuralGSA</Name>
    </ProjectReference>
    <ProjectReference Include="..\SpeckleStructuralRevit\SpeckleStructuralRevit.csproj">
      <Project>{c08796bb-c109-4961-ab72-a2a74c06e510}</Project>
      <Name>SpeckleStructuralRevit</Name>
    </ProjectReference>
    <ProjectReference Include="..\SpeckleStructuralClasses\SpeckleStructuralClasses.csproj">
      <Project>{42e1db9c-e4d5-4190-9977-874e8143dcc5}</Project>
      <Name>SpeckleStructuralClasses</Name>
    </ProjectReference>
  </ItemGroup>
  <ItemGroup>
    <None Include="app.config" />
    <None Include="packages.config" />
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
  <UsingTask TaskName="ILMerge.MSBuild.Tasks.ILMerge" AssemblyFile="$(SolutionDir)packages\ILMerge.MSBuild.Tasks.1.0.0.3\tools\ILMerge.MSBuild.Tasks.dll" />
  
  <Target Name="AfterBuild">
    <!-- For debug build, there is no merging of assemblies in SpeckleStructuralClasses (to help with intellisense)
	     so do that merging here, for the purpose of copying the result to the %localappdata% location -->
	<ItemGroup>
      <MergeAsm1 Include="$(TargetDir)SpeckleStructuralClasses.dll" />
      <MergeAsm1 Include="$(TargetDir)MathNet.Numerics.dll" />
      <MergeAsm1 Include="$(TargetDir)MathNet.Spatial.dll" />
    </ItemGroup>
    <PropertyGroup>
      <MergedAssembly1>$(ProjectDir)$(OutDir)SpeckleStructuralClasses.dll</MergedAssembly1>
    </PropertyGroup>
    <Message Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' " Text="ILMerge @(MergeAsm1) -&gt; $(MergedAssembly1)" Importance="high" />
    <ILMerge Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' " InputAssemblies="@(MergeAsm1)" OutputFile="$(MergedAssembly1)" TargetKind="SameAsPrimaryAssembly" />

    <!-- CopyLocal needs to be set to true for these files for for ilmerge to work - that is the case for both debug and release.
        The release config of SpeckleStructuralClasses deletes these right after merging assemblies (with ilmerge), 
		but this is not the case for debug build.
        So for the debug build, they remain and are copied to SpeckleStructural/bin/debug, so they can be deleted here -->
    <ItemGroup>
      <CopiedDllsToDel Include="$(TargetDir)MathNet.Numerics.*" />
      <CopiedDllsToDel Include="$(TargetDir)MathNet.Spatial.*" />
      <CopiedDllsToDel Include="$(TargetDir)Newtonsoft.Json.*" />
      <CopiedDllsToDel Include="$(TargetDir)websocket-sharp.*" />
      <CopiedDllsToDel Include="$(TargetDir)SpeckleCore*.*" />
    </ItemGroup>
    <Delete Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' " Files="@(CopiedDllsToDel)" />

    <!-- Debug builds result in more output files - useful for debugging.  For release builds being tested on the local computer,
         it is best if these extra files are deleted.  So for release builds only, delete all files in the %localappfiles% sub-directory for this kit -->
    <ItemGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
      <ReleaseCopiedDllsToDel Include="$(TargetDir)*.config" />
      <!-- remove output of previous debug builds -->
      <ReleaseCopiedDllsToDel Include="$(LocalAppData)\SpeckleKits\$(ProjectName)\*.*" />
    </ItemGroup>
    <Message Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' " Text="Removing previous files at $(LocalAppData)\SpeckleKits\$(ProjectName)" Importance="high" />
    <Delete Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' " Files="@(ReleaseCopiedDllsToDel)" />

    <!-- REMOVES CRUFT FROM SQLITE -->
    <RemoveDir Directories="$(TargetDir)x64" />
    <RemoveDir Directories="$(TargetDir)x86" />
    <ItemGroup>
      <BuildFiles Include="$(TargetDir)\*.*" />
    </ItemGroup>
    <Message Text="Copying built files to $(LocalAppData)\SpeckleKits\$(ProjectName)" Importance="high" />
    <Copy SourceFiles="@(BuildFiles)" DestinationFolder="$(LocalAppData)\SpeckleKits\$(ProjectName)" />
  </Target>
</Project>